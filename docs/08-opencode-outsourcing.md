# 08 — OpenCode 外包（把长任务交给 opencode 跑）

> 目标：当任务 **很长、需要大量检索/写作/汇总**，或希望把执行与主会话隔离时，用 OpenCode（`opencode` CLI）在本机跑一个“外包任务”，生成产出文件，再由主助手验收。

---

## 适用场景

- 长时间研究/资料汇总（例如：行业 Top10、竞品对比、资料摘录）
- 需要更大“执行空间”的任务：多轮 web search + 汇总写作
- 主会话不想被长任务阻塞（用后台进程跑）

不适用：
- 需要登录态/交互式网页操作（优先用 `browser`）
- 需要访问本机敏感数据（不要把 secrets/memory 交给外包流程）

---

## 约定与产出格式（建议）

### 输入：任务文件（markdown）
- 路径建议：`outsource/task_<topic>.md`
- 内容建议包含：
  - 目标（你要输出什么）
  - 输出格式（markdown/表格/要不要引用）
  - 约束（时间范围、数据口径、必须给来源链接等）
  - 输出路径（让它把结果写到 `out/xxx.md`）

### 输出：两类文件
- **运行日志**（记录命令、过程、是否成功）：建议保存到 `outsource/*.out.md`
- **最终交付物**：保存到 `out/*.md`

（我们已跑通的例子：生成 `out/usa_electric_power_top10.md`，日志在 `outsource/us_top10.out.md`）

---

## 标准执行命令（模板）

> 以实际模型名、任务文件路径为准。

```bash
/root/.opencode/bin/opencode run \
  -m opencode/kimi-k2.5-free \
  -f outsource/task_<topic>.md \
  --title "<title>" \
  "按附件任务输出"
```

### 推荐运行方式（避免阻塞）
- 用 OpenClaw 的 `exec(background=true)` 启动
- 用 `process` 轮询日志

---

## 验收清单（主助手必须做）

外包完成后，主助手不要“直接转发结果”，建议按以下步骤验收：

1) **输出是否落到指定路径**（`out/*.md`）
2) **是否满足口径**（时间范围/口径/TopN 定义/单位）
3) **是否提供可追溯来源**（链接或引用）
4) **是否有明显编造**（对关键数字/公司列表做 spot check）
5) 必要时：用 `web_fetch`/`web_search` 对关键结论复核 2~3 条

---

## 常见问题：进程被杀（SIGKILL / OOM）

你可能会看到类似：`signal SIGKILL`（例如某次 exec 里出现 `sharp-da` 被 kill）。一般不是“逻辑错误”，而是资源/守护策略导致。

### 排查顺序（从快到慢）
1) **先看当次日志**：是否已经产出部分结果？是否卡在某个步骤？
2) **看机器资源**（CPU/内存/Swap）：是否在高峰期被 OOM killer 杀掉
3) **缩小任务**：
   - 把任务拆成 2~3 个子任务分别跑
   - 限制输出范围（减少一次性检索/写作量）
4) **改为分段产出**：要求外包过程先写草稿文件，再汇总，降低单步内存峰值

### 预防建议
- 默认从“小任务 + 小输出”开始试跑
- 对“超长研究”优先拆分，而不是让一次 run 做完所有事

---

## 安全边界（公开仓库必须强调）

- 不要在任务文件里写入任何 token / PAT / cookie / credentials
- 不要让外包任务读取 `memory/`、`secrets/`、聊天 transcript
- 如果需要引用私密材料：先人工脱敏/摘录成安全片段，再交给外包流程
